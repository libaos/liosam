<launch>
  <arg name="world_name" default="$(find pcd_gazebo_world)/worlds/orchard_from_pcd.world"/>
  <arg name="paused" default="false"/>
  <arg name="gui" default="true"/>
  <arg name="use_sim_time" default="true"/>
  <arg name="gazebo_master_uri" default="$(optenv GAZEBO_MASTER_URI http://localhost:11345)"/>
  <arg name="gazebo_ip" default="$(optenv GAZEBO_IP 127.0.0.1)"/>
  <arg name="gpu" default="false"/>
  <arg name="organize_cloud" default="false"/>
  <arg name="lidar_hz" default="5"/>
  <arg name="lidar_samples" default="120"/>
  <arg name="use_skid_steer" default="false"/>
  <arg name="use_planar_move" default="true"/>
  <arg name="planner_frequency" default="2.0"/>
  <arg name="controller_frequency" default="5.0"/>
  <arg name="local_costmap_update_frequency" default="5.0"/>
  <arg name="local_costmap_publish_frequency" default="2.0"/>

  <arg name="path_file" default="$(find pcd_gazebo_world)/maps/runs/rosbag_path.json"/>
  <arg name="path_frame" default="map"/>
  <arg name="path_rate" default="1.0"/>
  <arg name="via_points_topic" default="/move_base_benchmark/TebLocalPlannerROS/via_points"/>
  <arg name="use_via_points" default="false"/>
  <arg name="goal_topic" default="/move_base_simple/goal"/>
  <arg name="use_waypoint_goals" default="true"/>
  <arg name="waypoint_min_dist" default="0.5"/>
  <!-- TEB + custom via-points tends to track the reference with a small lateral offset; allow a looser reach tolerance. -->
  <arg name="waypoint_tolerance" default="$(eval '0.6' if str(arg('use_via_points')).lower() in ['true','1','yes'] else '0.35')"/>

  <arg name="model_name" default="scout"/>
  <arg name="path_index" default="0"/>
  <arg name="spawn_z" default="0.2"/>

  <arg name="map_yaml" default="$(find pcd_gazebo_world)/maps/orchard_from_pcd_validated_by_bag/map.yaml"/>
  <arg name="costmap_common_params" default="$(find pcd_gazebo_world)/config/orchard_costmap_common_velodyne.yaml"/>
  <arg name="global_costmap_params" default="$(find move_base_benchmark)/params/global_costmap_params.yaml"/>
  <arg name="local_costmap_params" default="$(find move_base_benchmark)/params/orchard_local_costmap_params.yaml"/>
  <arg name="local_planner_params" default="$(find move_base_benchmark)/params/orchard_teb_local_planner_params.yaml"/>
  <arg name="local_planner_override_params" default="$(find pcd_gazebo_world)/config/teb_via_points_override.yaml"/>

  <arg name="global_frame" default="map"/>
  <arg name="local_frame" default="odom"/>
  <arg name="base_frame" default="base_link"/>
  <arg name="odom_topic" default="/odom"/>

  <arg name="record_csv" default="$(env PWD)/trajectory_data/teb_odom.csv"/>

  <param name="use_sim_time" value="$(arg use_sim_time)"/>

  <include file="$(find pcd_gazebo_world)/launch/orchard_pcd_sim.launch">
    <arg name="world_name" value="$(arg world_name)"/>
    <arg name="paused" value="$(arg paused)"/>
    <arg name="gui" value="$(arg gui)"/>
    <arg name="use_sim_time" value="$(arg use_sim_time)"/>
    <arg name="gazebo_master_uri" value="$(arg gazebo_master_uri)"/>
    <arg name="gazebo_ip" value="$(arg gazebo_ip)"/>
    <arg name="gpu" value="$(arg gpu)"/>
    <arg name="organize_cloud" value="$(arg organize_cloud)"/>
    <arg name="lidar_hz" value="$(arg lidar_hz)"/>
    <arg name="lidar_samples" value="$(arg lidar_samples)"/>
    <arg name="use_skid_steer" value="$(arg use_skid_steer)"/>
    <arg name="use_planar_move" value="$(arg use_planar_move)"/>
    <arg name="pub_clock_frequency" value="100"/>
  </include>

  <!-- Align map->odom using the path start pose and the first /odom message (Gazebo odom may start at 0,0). -->
  <node pkg="pcd_gazebo_world" type="set_map_to_odom_from_path.py" name="set_map_to_odom" output="screen"
        args="--path $(arg path_file) --index $(arg path_index) --map-frame $(arg global_frame) --odom-frame $(arg local_frame) --odom-topic $(arg odom_topic) --wait 12"/>

  <node pkg="pcd_gazebo_world" type="set_model_pose_from_path.py" name="set_model_pose" output="screen"
        args="--path $(arg path_file) --model $(arg model_name) --index $(arg path_index) --z $(arg spawn_z) --wait 12"/>

  <node pkg="move_base_benchmark" type="move_base_benchmark" respawn="false" name="move_base_benchmark" output="screen">
    <rosparam file="$(arg costmap_common_params)" command="load" ns="global_costmap"/>
    <rosparam file="$(arg costmap_common_params)" command="load" ns="local_costmap"/>
    <rosparam file="$(arg global_costmap_params)" command="load"/>
    <rosparam file="$(arg local_costmap_params)" command="load"/>

    <param name="global_costmap/global_frame" value="$(arg global_frame)"/>
    <param name="local_costmap/global_frame" value="$(arg local_frame)"/>
    <param name="global_costmap/robot_base_frame" value="$(arg base_frame)"/>
    <param name="local_costmap/robot_base_frame" value="$(arg base_frame)"/>

    <param name="base_global_planner" value="navfn/NavfnROS"/>
    <param name="planner_frequency" value="$(arg planner_frequency)"/>
    <param name="planner_patience" value="5.0"/>

    <param name="base_local_planner" value="teb_local_planner/TebLocalPlannerROS"/>
    <rosparam file="$(arg local_planner_params)" command="load"/>
    <rosparam file="$(arg local_planner_override_params)" command="load"/>
    <param name="controller_frequency" value="$(arg controller_frequency)"/>
    <param name="controller_patience" value="15.0"/>

    <param name="local_costmap/update_frequency" value="$(arg local_costmap_update_frequency)"/>
    <param name="local_costmap/publish_frequency" value="$(arg local_costmap_publish_frequency)"/>

    <remap from="odom" to="$(arg odom_topic)"/>
  </node>

  <node name="map_server" pkg="map_server" type="map_server" args="$(arg map_yaml)" output="screen">
    <param name="frame_id" value="$(arg global_frame)"/>
  </node>

  <!-- Publish a short window of custom via-points (teb_local_planner does not TF-transform them). -->
  <node if="$(arg use_via_points)" pkg="pcd_gazebo_world" type="publish_via_points_window.py" name="publish_via_points" output="screen"
        args="--path $(arg path_file) --topic $(arg via_points_topic) --odom-topic $(arg odom_topic) --path-frame $(arg path_frame) --local-frame $(arg local_frame) --rate 5.0 --window-dist 3.0 --min-sep 0.5 --max-points 12"/>

  <!-- Publish intermediate goals so the robot traverses loop-like paths. -->
  <node if="$(arg use_waypoint_goals)" pkg="pcd_gazebo_world" type="follow_path_goals.py" name="follow_path_goals" output="screen"
        args="--path $(arg path_file) --frame-id $(arg path_frame) --goal-topic $(arg goal_topic) --odom-topic $(arg odom_topic) --min-dist $(arg waypoint_min_dist)">
    <param name="goal_tolerance" value="$(arg waypoint_tolerance)"/>
  </node>

  <node pkg="pcd_gazebo_world" type="record_trajectory.py" name="record_trajectory" output="screen"
        args="--out $(arg record_csv) --odom-topic /odom --output-frame $(arg global_frame) --tf-timeout 0.5"/>
</launch>
