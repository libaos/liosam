<launch>
  <arg name="world_name" default="$(find pcd_gazebo_world)/worlds/orchard_from_pcd.world"/>
  <arg name="paused" default="false"/>
  <arg name="gui" default="true"/>
  <arg name="use_sim_time" default="true"/>
  <arg name="gazebo_master_uri" default="$(optenv GAZEBO_MASTER_URI http://localhost:11345)"/>
  <arg name="gazebo_ip" default="$(optenv GAZEBO_IP 127.0.0.1)"/>
  <arg name="gpu" default="false"/>
  <arg name="organize_cloud" default="false"/>
  <arg name="lidar_hz" default="5"/>
  <arg name="lidar_samples" default="120"/>
  <arg name="use_skid_steer" default="false"/>
  <arg name="use_planar_move" default="true"/>

  <arg name="path_file" default="$(find pcd_gazebo_world)/maps/runs/rosbag_path.json"/>
  <arg name="path_frame" default="odom"/>
  <arg name="path_rate" default="1.0"/>

  <arg name="model_name" default="scout"/>
  <arg name="path_index" default="0"/>
  <arg name="spawn_z" default="0.2"/>

  <arg name="record_csv" default="$(env PWD)/trajectory_data/pid_odom.csv"/>

  <arg name="pid_kp" default="1.6"/>
  <arg name="pid_ki" default="0.0"/>
  <arg name="pid_kd" default="0.15"/>
  <arg name="pid_v_max" default="0.45"/>
  <arg name="pid_v_min" default="0.05"/>
  <arg name="pid_max_omega" default="0.8"/>
  <arg name="pid_lookahead" default="0.8"/>
  <arg name="pid_k_dist" default="0.8"/>
  <arg name="pid_goal_tolerance" default="0.4"/>

  <param name="use_sim_time" value="$(arg use_sim_time)"/>

  <include file="$(find pcd_gazebo_world)/launch/orchard_pcd_sim.launch">
    <arg name="world_name" value="$(arg world_name)"/>
    <arg name="paused" value="$(arg paused)"/>
    <arg name="gui" value="$(arg gui)"/>
    <arg name="use_sim_time" value="$(arg use_sim_time)"/>
    <arg name="gazebo_master_uri" value="$(arg gazebo_master_uri)"/>
    <arg name="gazebo_ip" value="$(arg gazebo_ip)"/>
    <arg name="gpu" value="$(arg gpu)"/>
    <arg name="organize_cloud" value="$(arg organize_cloud)"/>
    <arg name="lidar_hz" value="$(arg lidar_hz)"/>
    <arg name="lidar_samples" value="$(arg lidar_samples)"/>
    <arg name="use_skid_steer" value="$(arg use_skid_steer)"/>
    <arg name="use_planar_move" value="$(arg use_planar_move)"/>
  </include>

  <node pkg="pcd_gazebo_world" type="set_model_pose_from_path.py" name="set_model_pose" output="screen"
        args="--path $(arg path_file) --model $(arg model_name) --index $(arg path_index) --z $(arg spawn_z) --wait 12"/>

  <node pkg="pcd_gazebo_world" type="publish_path.py" name="publish_reference_path" output="screen"
        args="--path $(arg path_file) --topic /reference_path --frame-id $(arg path_frame) --rate $(arg path_rate) --publish-goal 0"/>

  <node pkg="pcd_gazebo_world" type="pid_path_follower.py" name="pid_path_follower" output="screen">
    <param name="kp" value="$(arg pid_kp)"/>
    <param name="ki" value="$(arg pid_ki)"/>
    <param name="kd" value="$(arg pid_kd)"/>
    <param name="v_max" value="$(arg pid_v_max)"/>
    <param name="v_min" value="$(arg pid_v_min)"/>
    <param name="max_omega" value="$(arg pid_max_omega)"/>
    <param name="lookahead" value="$(arg pid_lookahead)"/>
    <param name="k_dist" value="$(arg pid_k_dist)"/>
    <param name="goal_tolerance" value="$(arg pid_goal_tolerance)"/>
    <param name="path_topic" value="/reference_path"/>
    <param name="odom_topic" value="/odom"/>
    <param name="cmd_vel_topic" value="/cmd_vel"/>
  </node>

  <node pkg="pcd_gazebo_world" type="record_trajectory.py" name="record_trajectory" output="screen"
        args="--out $(arg record_csv) --odom-topic /odom"/>
</launch>
